<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Panadería Nubes - Control de Gastos y Ventas</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style id="app-style">
    body {
      background-color: #121212;
      color: #e0e0e0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    .pastel-theme {
      --primary-color: #f2d8d8;
      --secondary-color: #c9bbcf;
      --accent-color: #a685e2;
      --dark-bg: #1e1e2e;
      --card-bg: #2a2a3a;
    }
    
    .login-card {
      background-color: var(--card-bg);
      border-radius: 15px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
    }
    
    .btn-primary {
      background-color: var(--accent-color);
      transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
      background-color: #8a6ac0;
      transform: translateY(-2px);
    }
    
    .card {
      background-color: var(--card-bg);
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    input, select {
      background-color: #333344;
      color: #e0e0e0;
      border: 1px solid #555566;
    }
    
    table {
      border-collapse: separate;
      border-spacing: 0;
    }
    
    table th {
      background-color: var(--dark-bg);
      color: var(--primary-color);
      font-weight: 600;
    }
    
    table td, table th {
      padding: 12px;
      border-bottom: 1px solid #333344;
    }
    
    .sidebar {
      background-color: var(--dark-bg);
      height: 100vh;
      width: 250px;
      position: fixed;
      left: 0;
      top: 0;
      z-index: 10;
      transition: transform 0.3s ease;
    }
    
    .sidebar.collapsed {
      transform: translateX(-250px);
    }
    
    .content-area {
      margin-left: 250px;
      transition: margin 0.3s ease;
    }
    
    .content-area.full {
      margin-left: 0;
    }
    
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-250px);
      }
      
      .sidebar.mobile-open {
        transform: translateX(0);
      }
      
      .content-area {
        margin-left: 0;
      }
    }
    
    .summary-box {
      background: linear-gradient(145deg, #2a2a3a, #3a3a4a);
      border-left: 4px solid var(--accent-color);
    }
    
    .error-message {
      background-color: rgba(220, 38, 38, 0.2);
      border-left: 4px solid #dc2626;
      color: #fca5a5;
    }
    
    .success-message {
      background-color: rgba(16, 185, 129, 0.2);
      border-left: 4px solid #10b981;
      color: #6ee7b7;
    }
  </style>
</head>
<body class="pastel-theme">
  <!-- Login Screen -->
  <div id="login-screen" class="min-h-screen flex items-center justify-center p-4">
    <div class="login-card p-8 w-full max-w-md">
      <h1 class="text-3xl font-bold text-center mb-8 text-purple-300">Panadería Nubes</h1>
      <div class="mb-6">
        <img src="Images/LogoPanaderiaNubes.png" alt="Logo Panadería" class="w-32 h-32 mx-auto mb-4">
        <h2 class="text-xl text-center text-purple-200">Control de Gastos y Ventas</h2>
      </div>
      
      <form id="login-form" class="space-y-6">
        <div class="error-message p-3 rounded-md mb-4 hidden" id="login-error">
          Usuario o contraseña incorrectos
        </div>
        
        <div>
          <label class="block mb-2 text-sm font-medium" for="username">Usuario</label>
          <input type="text" id="username" class="w-full p-3 rounded-md" placeholder="Ingrese su usuario">
        </div>
        
        <div>
          <label class="block mb-2 text-sm font-medium" for="password">Contraseña</label>
          <input type="password" id="password" class="w-full p-3 rounded-md" placeholder="Ingrese su contraseña">
        </div>
        
        <button type="submit" id="login-button" class="w-full btn-primary text-white font-medium rounded-md p-3">
          Ingresar
        </button>
      </form>
    </div>
  </div>
  
  <!-- Main App - Initially Hidden -->
  <div id="app-container" class="hidden">
    <!-- Sidebar -->
    <nav id="sidebar" class="sidebar py-6 px-4">
      <div class="flex items-center justify-between mb-8">
        <h2 class="text-xl font-bold text-purple-300">Panadería Nubes</h2>
        <button id="collapse-sidebar" class="lg:block hidden text-xl">
          <i class="fas fa-bars"></i>
        </button>
      </div>
      
      <ul class="space-y-2">
        <li>
          <a href="javascript:void(0)" class="nav-link flex items-center p-3 rounded-md hover:bg-gray-700 active-nav" data-target="dashboard">
            <i class="fas fa-chart-pie w-6"></i>
            <span>Dashboard</span>
          </a>
        </li>
        <li>
          <a href="javascript:void(0)" class="nav-link flex items-center p-3 rounded-md hover:bg-gray-700" data-target="date-query">
            <i class="fas fa-calendar-alt w-6"></i>
            <span>Consulta por Fecha</span>
          </a>
        </li>
        <li>
          <a href="javascript:void(0)" class="nav-link flex items-center p-3 rounded-md hover:bg-gray-700" data-target="reports">
            <i class="fas fa-file-alt w-6"></i>
            <span>Reportes</span>
          </a>
        </li>
      </ul>
      
      <div class="mt-auto pt-8">
        <button id="logout-button" class="flex items-center p-3 w-full rounded-md hover:bg-red-900 text-red-300">
          <i class="fas fa-sign-out-alt w-6"></i>
          <span>Cerrar Sesión</span>
        </button>
      </div>
    </nav>
    
    <!-- Mobile Header -->
    <header class="lg:hidden fixed top-0 left-0 right-0 bg-gray-900 z-20 p-4 flex items-center justify-between shadow-lg">
      <button id="mobile-menu-button" class="text-xl">
        <i class="fas fa-bars"></i>
      </button>
      <h2 id="mobile-title" class="text-xl font-bold text-purple-300">Dashboard</h2>
      <div id="current-day-mobile" class="text-sm text-purple-200"></div>
    </header>
    
    <!-- Content Area -->
    <main id="content-area" class="content-area min-h-screen pt-6 px-4 pb-20 lg:pb-6">
      <div class="lg:flex items-center justify-between mb-8 mt-16 lg:mt-0">
        <div class="flex items-center">
          <h1 class="text-2xl font-bold mr-4">Dashboard</h1>
          <div id="current-day" class="text-purple-200 text-lg"></div>
        </div>
        <button id="desktop-logout" class="lg:block hidden px-4 py-2 bg-red-900 text-red-300 rounded-md hover:bg-red-800">
          Cerrar Sesión <i class="fas fa-sign-out-alt ml-2"></i>
        </button>
      </div>
      
      <!-- Dashboard Content -->
      <div id="dashboard-content" class="page-content">
        <div class="lg:flex lg:space-x-6 space-y-6 lg:space-y-0">
          <!-- Gastos Section -->
          <div class="card p-4 lg:w-1/2">
            <h2 class="text-xl font-bold mb-4">Registro de Gastos</h2>
            <div class="overflow-x-auto">
              <table id="expenses-table" class="w-full">
                <thead>
                  <tr>
                    <th>Nombre del gasto</th>
                    <th>Precio</th>
                    <th>Pertenece a Panadería</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- Rows will be added dynamically -->
                  <tr id="expense-new-row">
                    <td><input type="text" class="w-full p-2 rounded-md" id="new-expense-name"></td>
                    <td><input type="number" class="w-full p-2 rounded-md" id="new-expense-price" min="0"></td>
                    <td class="text-center">
                      <input type="checkbox" id="new-expense-belongs" class="w-5 h-5">
                    </td>
                    <td>
                      <button id="add-expense" class="p-2 bg-green-700 text-green-200 rounded-md">
                        <i class="fas fa-plus"></i>
                      </button>
                    </td>
                  </tr>
                </tbody>
                <tfoot>
                  <tr>
                    <td colspan="4" class="pt-4">
                      <div class="flex flex-col space-y-2">
                        <div class="flex justify-between">
                          <span>Total de gastos del día:</span>
                          <span id="total-expenses">$0.00</span>
                        </div>
                        <div class="flex justify-between">
                          <span>Total de gastos de panadería:</span>
                          <span id="total-bakery-expenses">$0.00</span>
                        </div>
                      </div>
                    </td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
          
          <!-- Ventas Section -->
          <div class="card p-4 lg:w-1/2">
            <h2 class="text-xl font-bold mb-4">Registro de Ventas</h2>
            <div class="space-y-4">
              <div>
                <label class="block mb-2">Cantidad vendida del día:</label>
                <input type="number" id="sales-amount" class="w-full p-3 rounded-md" min="0" step="0.01">
              </div>
              
              <div class="flex space-x-2">
                <button id="save-sales" class="p-2 bg-blue-700 text-blue-200 rounded-md flex-1">
                  <i class="fas fa-save mr-2"></i> Guardar
                </button>
                <button id="edit-sales" class="p-2 bg-yellow-700 text-yellow-200 rounded-md flex-1" disabled>
                  <i class="fas fa-edit mr-2"></i> Editar
                </button>
                <button id="delete-sales" class="p-2 bg-red-700 text-red-200 rounded-md flex-1" disabled>
                  <i class="fas fa-trash-alt mr-2"></i> Eliminar
                </button>
              </div>
              
              <div id="sales-success" class="success-message p-3 rounded-md mt-4 hidden">
                Venta guardada correctamente
              </div>
            </div>
          </div>
        </div>
        
        <!-- Daily Summary -->
        <div class="summary-box p-6 mt-6 rounded-md">
          <h2 class="text-xl font-bold mb-4">Resumen Diario</h2>
          <div class="grid lg:grid-cols-5 grid-cols-2 gap-4">
            <div class="p-3 bg-opacity-20 bg-purple-800 rounded-md">
              <div class="text-sm text-purple-300">Cantidad vendida</div>
              <div id="summary-sales" class="text-xl font-bold">$0.00</div>
            </div>
            <div class="p-3 bg-opacity-20 bg-red-800 rounded-md">
              <div class="text-sm text-red-300">Total de gastos</div>
              <div id="summary-expenses" class="text-xl font-bold">$0.00</div>
            </div>
            <div class="p-3 bg-opacity-20 bg-yellow-800 rounded-md">
              <div class="text-sm text-yellow-300">Total gastos panadería</div>
              <div id="summary-bakery-expenses" class="text-xl font-bold">$0.00</div>
            </div>
            <div class="p-3 bg-opacity-20 bg-green-800 rounded-md">
              <div class="text-sm text-green-300">Ganancia bruta</div>
              <div id="summary-gross-profit" class="text-xl font-bold">$0.00</div>
            </div>
            <div class="p-3 bg-opacity-20 bg-blue-800 rounded-md">
              <div class="text-sm text-blue-300">Ganancia neta panadería</div>
              <div id="summary-net-profit" class="text-xl font-bold">$0.00</div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Date Query Content -->
      <div id="date-query-content" class="page-content hidden">
        <div class="card p-6 mb-6">
          <h2 class="text-xl font-bold mb-4">Consulta por Fecha</h2>
          <div>
            <label class="block mb-2">Seleccione una fecha:</label>
            <input type="date" id="date-selector" class="w-full p-3 rounded-md">
          </div>
        </div>
        
        <div id="date-results" class="hidden">
          <div class="lg:flex lg:space-x-6 space-y-6 lg:space-y-0">
            <!-- Gastos Section -->
            <div class="card p-4 lg:w-1/2">
              <h2 class="text-xl font-bold mb-4">Gastos de la Fecha</h2>
              <div class="overflow-x-auto">
                <table id="date-expenses-table" class="w-full">
                  <thead>
                    <tr>
                      <th>Nombre del gasto</th>
                      <th>Precio</th>
                      <th>Pertenece a Panadería</th>
                    </tr>
                  </thead>
                  <tbody>
                    <!-- Date expenses will be loaded here -->
                  </tbody>
                  <tfoot>
                    <tr>
                      <td colspan="3" class="pt-4">
                        <div class="flex flex-col space-y-2">
                          <div class="flex justify-between">
                            <span>Total de gastos:</span>
                            <span id="date-total-expenses">$0.00</span>
                          </div>
                          <div class="flex justify-between">
                            <span>Total de gastos de panadería:</span>
                            <span id="date-total-bakery-expenses">$0.00</span>
                          </div>
                        </div>
                      </td>
                    </tr>
                  </tfoot>
                </table>
              </div>
            </div>
            
            <!-- Ventas Section -->
            <div class="card p-4 lg:w-1/2">
              <h2 class="text-xl font-bold mb-4">Ventas de la Fecha</h2>
              <div class="p-4 text-center">
                <div class="text-2xl font-bold" id="date-sales-amount">$0.00</div>
                <p class="text-sm text-gray-400">Cantidad vendida</p>
              </div>
            </div>
          </div>
          
          <!-- Date Summary -->
          <div class="summary-box p-6 mt-6 rounded-md">
            <h2 class="text-xl font-bold mb-4">Resumen de la Fecha</h2>
            <div class="grid lg:grid-cols-5 grid-cols-2 gap-4">
              <div class="p-3 bg-opacity-20 bg-purple-800 rounded-md">
                <div class="text-sm text-purple-300">Cantidad vendida</div>
                <div id="date-summary-sales" class="text-xl font-bold">$0.00</div>
              </div>
              <div class="p-3 bg-opacity-20 bg-red-800 rounded-md">
                <div class="text-sm text-red-300">Total de gastos</div>
                <div id="date-summary-expenses" class="text-xl font-bold">$0.00</div>
              </div>
              <div class="p-3 bg-opacity-20 bg-yellow-800 rounded-md">
                <div class="text-sm text-yellow-300">Total gastos panadería</div>
                <div id="date-summary-bakery-expenses" class="text-xl font-bold">$0.00</div>
              </div>
              <div class="p-3 bg-opacity-20 bg-green-800 rounded-md">
                <div class="text-sm text-green-300">Ganancia bruta</div>
                <div id="date-summary-gross-profit" class="text-xl font-bold">$0.00</div>
              </div>
              <div class="p-3 bg-opacity-20 bg-blue-800 rounded-md">
                <div class="text-sm text-blue-300">Ganancia neta panadería</div>
                <div id="date-summary-net-profit" class="text-xl font-bold">$0.00</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Reports Content -->
      <div id="reports-content" class="page-content hidden">
        <div class="card p-6 mb-6">
          <h2 class="text-xl font-bold mb-4">Reportes</h2>
          <div class="lg:flex lg:space-x-4 space-y-4 lg:space-y-0">
            <div class="lg:w-1/2">
              <label class="block mb-2">Tipo de reporte:</label>
              <select id="report-type" class="w-full p-3 rounded-md">
                <option value="weekly">Semanal (Lunes-Domingo)</option>
                <option value="monthly">Mensual</option>
              </select>
            </div>
            <div class="lg:w-1/2">
              <label class="block mb-2">Seleccione fecha inicial:</label>
              <input type="date" id="report-date" class="w-full p-3 rounded-md">
            </div>
          </div>
          
          <div class="mt-4">
            <button id="generate-report" class="p-2 bg-blue-700 text-blue-200 rounded-md w-full">
              <i class="fas fa-chart-bar mr-2"></i> Generar Reporte
            </button>
          </div>
        </div>
        
        <div id="report-results" class="hidden">
          <div class="card p-6">
            <div class="flex justify-between items-center mb-4">
              <h2 class="text-xl font-bold" id="report-title">Reporte</h2>
              <button id="export-csv" class="p-2 bg-green-700 text-green-200 rounded-md">
                <i class="fas fa-file-csv mr-2"></i> Exportar CSV
              </button>
            </div>
            
            <div class="overflow-x-auto">
              <table class="w-full" id="report-table">
                <thead>
                  <tr>
                    <th>Concepto</th>
                    <th>Monto</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>Total Ventas</td>
                    <td id="report-total-sales">$0.00</td>
                  </tr>
                  <tr>
                    <td>Total Gastos</td>
                    <td id="report-total-expenses">$0.00</td>
                  </tr>
                  <tr>
                    <td>Total Gastos Panadería</td>
                    <td id="report-total-bakery-expenses">$0.00</td>
                  </tr>
                  <tr class="font-bold">
                    <td>Ganancia Bruta</td>
                    <td id="report-gross-profit">$0.00</td>
                  </tr>
                  <tr class="font-bold">
                    <td>Ganancia Neta Panadería</td>
                    <td id="report-net-profit">$0.00</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script id="app-script">
    document.addEventListener('DOMContentLoaded', () => {
      // Helper function to get local date in YYYY-MM-DD format
      function getLocalDateKey(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      }
      
      // Day name in Spanish
      const daysInSpanish = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
      const monthsInSpanish = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
      
      // Remove top-level date key variables and move them into a function
      const today = new Date();
      const dayName = daysInSpanish[today.getDay()];
      const currentDayFormatted = `${dayName}, ${today.getDate()} de ${monthsInSpanish[today.getMonth()]} de ${today.getFullYear()}`;
      
      document.getElementById('current-day').textContent = currentDayFormatted;
      document.getElementById('current-day-mobile').textContent = currentDayFormatted;
      
      // Set default date for date query to today
      const todayFormatted = getLocalDateKey(today);
      document.getElementById('date-selector').value = todayFormatted;
      document.getElementById('report-date').value = todayFormatted;
      
      // Login functionality
      const loginForm = document.getElementById('login-form');
      const loginError = document.getElementById('login-error');
      
      loginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        
        if (username === 'PanaderiaNubes' && password === 'Latoso8110') {
          // Store login state in localStorage
          localStorage.setItem('panaderiaNubesLoggedIn', 'true');
          
          // Hide login screen and show app
          document.getElementById('login-screen').classList.add('hidden');
          document.getElementById('app-container').classList.remove('hidden');
        } else {
          loginError.classList.remove('hidden');
          setTimeout(() => {
            loginError.classList.add('hidden');
          }, 3000);
        }
      });
      
      // Check if user is logged in
      if (localStorage.getItem('panaderiaNubesLoggedIn') === 'true') {
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('app-container').classList.remove('hidden');
      }
      
      // Logout functionality
      document.getElementById('logout-button').addEventListener('click', logout);
      document.getElementById('desktop-logout').addEventListener('click', logout);
      
      function logout() {
        localStorage.removeItem('panaderiaNubesLoggedIn');
        document.getElementById('app-container').classList.add('hidden');
        document.getElementById('login-screen').classList.remove('hidden');
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
      }
      
      // Sidebar toggle
      const sidebar = document.getElementById('sidebar');
      const contentArea = document.getElementById('content-area');
      
      document.getElementById('collapse-sidebar').addEventListener('click', () => {
        sidebar.classList.toggle('collapsed');
        contentArea.classList.toggle('full');
      });
      
      // Mobile menu
      document.getElementById('mobile-menu-button').addEventListener('click', () => {
        sidebar.classList.toggle('mobile-open');
      });
      
      // Navigation
      const navLinks = document.querySelectorAll('.nav-link');
      const pageContents = document.querySelectorAll('.page-content');
      const mobileTitle = document.getElementById('mobile-title');
      
      navLinks.forEach(link => {
        link.addEventListener('click', () => {
          const target = link.getAttribute('data-target');
          
          // Update active class
          navLinks.forEach(l => l.classList.remove('active-nav', 'bg-gray-700'));
          link.classList.add('active-nav', 'bg-gray-700');
          
          // Show correct content
          pageContents.forEach(content => {
            content.classList.add('hidden');
          });
          document.getElementById(`${target}-content`).classList.remove('hidden');
          
          // Initialize today's data when dashboard is shown
          if (target === 'dashboard') {
            initTodayData();
          }
          
          // Update mobile title
          mobileTitle.textContent = link.querySelector('span').textContent;
          
          // Close mobile menu when link clicked
          sidebar.classList.remove('mobile-open');
        });
      });
      
      // Expenses functionality
      const addExpenseBtn = document.getElementById('add-expense');
      const expensesTable = document.getElementById('expenses-table').querySelector('tbody');
      
      // Remove top-level initialization of expenses
      let expenses = [];
      
      // Sales functionality
      let salesAmount = 0;
      const salesInput = document.getElementById('sales-amount');
      const saveSalesBtn = document.getElementById('save-sales');
      const editSalesBtn = document.getElementById('edit-sales');
      const deleteSalesBtn = document.getElementById('delete-sales');
      const salesSuccess = document.getElementById('sales-success');
      
      // Initialize today's data
      function initTodayData() {
        const todayDateKey = `expenses_${getLocalDateKey(new Date())}`;
        expenses = JSON.parse(localStorage.getItem(todayDateKey)) || [];
        
        const salesDateKey = `sales_${getLocalDateKey(new Date())}`;
        salesAmount = parseFloat(localStorage.getItem(salesDateKey)) || 0;
        
        // Update sales UI based on loaded data
        if (salesAmount > 0) {
          salesInput.value = salesAmount;
          salesInput.disabled = true;
          saveSalesBtn.disabled = true;
          editSalesBtn.disabled = false;
          deleteSalesBtn.disabled = false;
        } else {
          salesInput.value = '';
          salesInput.disabled = false;
          saveSalesBtn.disabled = false;
          editSalesBtn.disabled = true;
          deleteSalesBtn.disabled = true;
        }
        
        // Load expenses and update UI
        loadExpenses();
        updateExpenseTotals();
        updateSummary();
      }
      
      // Run initialization
      initTodayData();
      
      // Add expense - Use dynamic date key
      addExpenseBtn.addEventListener('click', () => {
        const name = document.getElementById('new-expense-name').value.trim();
        const price = parseFloat(document.getElementById('new-expense-price').value);
        const belongsToBakery = document.getElementById('new-expense-belongs').checked;
        
        if (name && !isNaN(price) && price > 0) {
          const expense = {
            id: Date.now(),
            name,
            price,
            belongsToBakery
          };
          
          expenses.push(expense);
          const todayDateKey = `expenses_${getLocalDateKey(new Date())}`;
          localStorage.setItem(todayDateKey, JSON.stringify(expenses));
          
          addExpenseToTable(expense);
          updateExpenseTotals();
          updateSummary();
          
          // Clear form
          document.getElementById('new-expense-name').value = '';
          document.getElementById('new-expense-price').value = '';
          document.getElementById('new-expense-belongs').checked = false;
        }
      });
      
      function loadExpenses() {
        // Clear table first (except the new expense row)
        const rows = expensesTable.querySelectorAll('tr:not(#expense-new-row)');
        rows.forEach(row => row.remove());
        
        // Add expenses to table
        expenses.forEach(expense => {
          addExpenseToTable(expense);
        });
      }
      
      function addExpenseToTable(expense) {
        const row = document.createElement('tr');
        row.dataset.id = expense.id;
        
        row.innerHTML = `
          <td>${expense.name}</td>
          <td>$${expense.price.toFixed(2)}</td>
          <td class="text-center">${expense.belongsToBakery ? '<i class="fas fa-check text-green-500"></i>' : '<i class="fas fa-times text-red-500"></i>'}</td>
          <td>
            <div class="flex space-x-2">
              <button class="edit-expense p-2 bg-yellow-700 text-yellow-200 rounded-md">
                <i class="fas fa-edit"></i>
              </button>
              <button class="delete-expense p-2 bg-red-700 text-red-200 rounded-md">
                <i class="fas fa-trash-alt"></i>
              </button>
            </div>
          </td>
        `;
        
        // Insert before the new expense row
        expensesTable.insertBefore(row, document.getElementById('expense-new-row'));
        
        // Add event listeners
        row.querySelector('.edit-expense').addEventListener('click', () => {
          editExpense(expense.id);
        });
        
        row.querySelector('.delete-expense').addEventListener('click', () => {
          deleteExpense(expense.id);
        });
      }
      
      function editExpense(id) {
        const expense = expenses.find(e => e.id === id);
        if (!expense) return;
        
        const row = expensesTable.querySelector(`tr[data-id="${id}"]`);
        
        row.innerHTML = `
          <td><input type="text" class="w-full p-2 rounded-md" value="${expense.name}"></td>
          <td><input type="number" class="w-full p-2 rounded-md" value="${expense.price}" min="0"></td>
          <td class="text-center">
            <input type="checkbox" class="w-5 h-5" ${expense.belongsToBakery ? 'checked' : ''}>
          </td>
          <td>
            <div class="flex space-x-2">
              <button class="save-edit p-2 bg-green-700 text-green-200 rounded-md">
                <i class="fas fa-save"></i>
              </button>
              <button class="cancel-edit p-2 bg-gray-700 text-gray-200 rounded-md">
                <i class="fas fa-times"></i>
              </button>
            </div>
          </td>
        `;
        
        row.querySelector('.save-edit').addEventListener('click', () => {
          const newName = row.querySelector('input[type="text"]').value.trim();
          const newPrice = parseFloat(row.querySelector('input[type="number"]').value);
          const newBelongsToBakery = row.querySelector('input[type="checkbox"]').checked;
          
          if (newName && !isNaN(newPrice) && newPrice > 0) {
            expense.name = newName;
            expense.price = newPrice;
            expense.belongsToBakery = newBelongsToBakery;
            
            const todayDateKey = `expenses_${getLocalDateKey(new Date())}`;
            localStorage.setItem(todayDateKey, JSON.stringify(expenses));
            
            // Update the row
            row.innerHTML = `
              <td>${expense.name}</td>
              <td>$${expense.price.toFixed(2)}</td>
              <td class="text-center">${expense.belongsToBakery ? '<i class="fas fa-check text-green-500"></i>' : '<i class="fas fa-times text-red-500"></i>'}</td>
              <td>
                <div class="flex space-x-2">
                  <button class="edit-expense p-2 bg-yellow-700 text-yellow-200 rounded-md">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="delete-expense p-2 bg-red-700 text-red-200 rounded-md">
                    <i class="fas fa-trash-alt"></i>
                  </button>
                </div>
              </td>
            `;
            
            // Add event listeners again
            row.querySelector('.edit-expense').addEventListener('click', () => {
              editExpense(expense.id);
            });
            
            row.querySelector('.delete-expense').addEventListener('click', () => {
              deleteExpense(expense.id);
            });
            
            updateExpenseTotals();
            updateSummary();
          }
        });
        
        row.querySelector('.cancel-edit').addEventListener('click', () => {
          // Just reload the row
          row.innerHTML = `
            <td>${expense.name}</td>
            <td>$${expense.price.toFixed(2)}</td>
            <td class="text-center">${expense.belongsToBakery ? '<i class="fas fa-check text-green-500"></i>' : '<i class="fas fa-times text-red-500"></i>'}</td>
            <td>
              <div class="flex space-x-2">
                <button class="edit-expense p-2 bg-yellow-700 text-yellow-200 rounded-md">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="delete-expense p-2 bg-red-700 text-red-200 rounded-md">
                  <i class="fas fa-trash-alt"></i>
                </button>
              </div>
            </td>
          `;
          
          // Add event listeners again
          row.querySelector('.edit-expense').addEventListener('click', () => {
            editExpense(expense.id);
          });
          
          row.querySelector('.delete-expense').addEventListener('click', () => {
            deleteExpense(expense.id);
          });
        });
      }
      
      function deleteExpense(id) {
        if (confirm('¿Está seguro que desea eliminar este gasto?')) {
          expenses = expenses.filter(e => e.id !== id);
          const todayDateKey = `expenses_${getLocalDateKey(new Date())}`;
          localStorage.setItem(todayDateKey, JSON.stringify(expenses));
          
          const row = expensesTable.querySelector(`tr[data-id="${id}"]`);
          row.remove();
          
          updateExpenseTotals();
          updateSummary();
        }
      }
      
      function updateExpenseTotals() {
        const totalExpenses = expenses.reduce((total, expense) => total + expense.price, 0);
        const totalBakeryExpenses = expenses
          .filter(expense => expense.belongsToBakery)
          .reduce((total, expense) => total + expense.price, 0);
        
        document.getElementById('total-expenses').textContent = `$${totalExpenses.toFixed(2)}`;
        document.getElementById('total-bakery-expenses').textContent = `$${totalBakeryExpenses.toFixed(2)}`;
      }
      
      // Sales functionality
      saveSalesBtn.addEventListener('click', () => {
        const amount = parseFloat(salesInput.value);
        if (!isNaN(amount) && amount >= 0) {
          salesAmount = amount;
          const salesDateKey = `sales_${getLocalDateKey(new Date())}`;
          localStorage.setItem(salesDateKey, salesAmount);
          
          salesInput.disabled = true;
          saveSalesBtn.disabled = true;
          editSalesBtn.disabled = false;
          deleteSalesBtn.disabled = false;
          
          salesSuccess.classList.remove('hidden');
          setTimeout(() => {
            salesSuccess.classList.add('hidden');
          }, 3000);
          
          updateSummary();
        }
      });
      
      // Delete sales - Use dynamic date key
      deleteSalesBtn.addEventListener('click', () => {
        if (confirm('¿Está seguro que desea eliminar las ventas del día?')) {
          const salesDateKey = `sales_${getLocalDateKey(new Date())}`;
          localStorage.removeItem(salesDateKey);
          salesAmount = 0;
          salesInput.value = '';
          salesInput.disabled = false;
          saveSalesBtn.disabled = false;
          editSalesBtn.disabled = true;
          deleteSalesBtn.disabled = true;
          
          updateSummary();
        }
      });
      
      // Summary update
      function updateSummary() {
        const totalExpenses = expenses.reduce((total, expense) => total + expense.price, 0);
        const totalBakeryExpenses = expenses
          .filter(expense => expense.belongsToBakery)
          .reduce((total, expense) => total + expense.price, 0);
        
        const grossProfit = salesAmount - totalExpenses;
        const netProfit = salesAmount - totalBakeryExpenses;
        
        document.getElementById('summary-sales').textContent = `$${salesAmount.toFixed(2)}`;
        document.getElementById('summary-expenses').textContent = `$${totalExpenses.toFixed(2)}`;
        document.getElementById('summary-bakery-expenses').textContent = `$${totalBakeryExpenses.toFixed(2)}`;
        document.getElementById('summary-gross-profit').textContent = `$${grossProfit.toFixed(2)}`;
        document.getElementById('summary-net-profit').textContent = `$${netProfit.toFixed(2)}`;
      }
      
      // Initialize summary
      updateSummary();
      
      // Date query functionality
      document.getElementById('date-selector').addEventListener('change', function() {
        const selectedDate = this.value;
        const selectedDateExpensesKey = `expenses_${selectedDate}`;
        const selectedDateSalesKey = `sales_${selectedDate}`;
        
        const selectedDateExpenses = JSON.parse(localStorage.getItem(selectedDateExpensesKey)) || [];
        const selectedDateSales = parseFloat(localStorage.getItem(selectedDateSalesKey)) || 0;
        
        // Show results
        document.getElementById('date-results').classList.remove('hidden');
        
        // Load expenses
        const dateExpensesTable = document.getElementById('date-expenses-table').querySelector('tbody');
        dateExpensesTable.innerHTML = '';
        
        selectedDateExpenses.forEach(expense => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${expense.name}</td>
            <td>$${expense.price.toFixed(2)}</td>
            <td class="text-center">${expense.belongsToBakery ? '<i class="fas fa-check text-green-500"></i>' : '<i class="fas fa-times text-red-500"></i>'}</td>
          `;
          dateExpensesTable.appendChild(row);
        });
        
        // Calculate totals
        const totalExpenses = selectedDateExpenses.reduce((total, expense) => total + expense.price, 0);
        const totalBakeryExpenses = selectedDateExpenses
          .filter(expense => expense.belongsToBakery)
          .reduce((total, expense) => total + expense.price, 0);
          
        document.getElementById('date-total-expenses').textContent = `$${totalExpenses.toFixed(2)}`;
        document.getElementById('date-total-bakery-expenses').textContent = `$${totalBakeryExpenses.toFixed(2)}`;
        
        // Show sales
        document.getElementById('date-sales-amount').textContent = `$${selectedDateSales.toFixed(2)}`;
        
        // Update summary
        const grossProfit = selectedDateSales - totalExpenses;
        const netProfit = selectedDateSales - totalBakeryExpenses;
        
        document.getElementById('date-summary-sales').textContent = `$${selectedDateSales.toFixed(2)}`;
        document.getElementById('date-summary-expenses').textContent = `$${totalExpenses.toFixed(2)}`;
        document.getElementById('date-summary-bakery-expenses').textContent = `$${totalBakeryExpenses.toFixed(2)}`;
        document.getElementById('date-summary-gross-profit').textContent = `$${grossProfit.toFixed(2)}`;
        document.getElementById('date-summary-net-profit').textContent = `$${netProfit.toFixed(2)}`;
      });
      
      // Reports functionality
      document.getElementById('generate-report').addEventListener('click', function() {
        const reportType = document.getElementById('report-type').value;
        const reportDateRaw = document.getElementById('report-date').value;
        const reportDate = new Date(reportDateRaw + 'T00:00');
        
        let reportTitle = '';
        let startDate, endDate;
        
        if (reportType === 'weekly') {
          // Get the Monday of the week
          const day = reportDate.getDay();
          const diff = reportDate.getDate() - day + (day === 0 ? -6 : 1); // adjust when day is Sunday
          startDate = new Date(reportDate);
          startDate.setDate(diff);
          
          // Get the Sunday
          endDate = new Date(startDate);
          endDate.setDate(startDate.getDate() + 6);
          
          reportTitle = `Reporte Semanal: ${startDate.getDate()} al ${endDate.getDate()} de ${monthsInSpanish[startDate.getMonth()]} de ${startDate.getFullYear()}`;
        } else {
          // Monthly report
          startDate = new Date(reportDate.getFullYear(), reportDate.getMonth(), 1);
          endDate = new Date(reportDate.getFullYear(), reportDate.getMonth() + 1, 0);
          
          reportTitle = `Reporte Mensual: ${monthsInSpanish[startDate.getMonth()]} de ${startDate.getFullYear()}`;
        }
        
        // Calculate totals
        let totalSales = 0;
        let totalExpenses = 0;
        let totalBakeryExpenses = 0;
        
        // Loop through each day in the range
        for (let d = new Date(startDate.getTime()); d <= endDate; d.setDate(d.getDate() + 1)) {
          const date = new Date(d);
          const dateStr = getLocalDateKey(date);
          const readableDate = `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`;
          const dateExpensesKey = `expenses_${dateStr}`;
          const dateSalesKey = `sales_${dateStr}`;
          
          // Add sales
          const dateSales = parseFloat(localStorage.getItem(dateSalesKey)) || 0;
          totalSales += dateSales;
          
          // Add expenses
          const dateExpenses = JSON.parse(localStorage.getItem(dateExpensesKey)) || [];
          totalExpenses += dateExpenses.reduce((total, expense) => total + expense.price, 0);
          totalBakeryExpenses += dateExpenses
            .filter(expense => expense.belongsToBakery)
            .reduce((total, expense) => total + expense.price, 0);
        }
        
        // Calculate profit
        const grossProfit = totalSales - totalExpenses;
        const netProfit = totalSales - totalBakeryExpenses;
        
        // Update report title
        document.getElementById('report-title').textContent = reportTitle;
        
        // Update table values
        document.getElementById('report-total-sales').textContent = `$${totalSales.toFixed(2)}`;
        document.getElementById('report-total-expenses').textContent = `$${totalExpenses.toFixed(2)}`;
        document.getElementById('report-total-bakery-expenses').textContent = `$${totalBakeryExpenses.toFixed(2)}`;
        document.getElementById('report-gross-profit').textContent = `$${grossProfit.toFixed(2)}`;
        document.getElementById('report-net-profit').textContent = `$${netProfit.toFixed(2)}`;
        
        // Show report
        document.getElementById('report-results').classList.remove('hidden');
      });
      
      // Export CSV
      document.getElementById('export-csv').addEventListener('click', function() {
        const reportType = document.getElementById('report-type').value;
        const reportDateRaw = document.getElementById('report-date').value;
        const reportDate = new Date(reportDateRaw + 'T00:00');
        
        let reportTitle = '';
        let startDate, endDate;
        
        if (reportType === 'weekly') {
          const day = reportDate.getDay();
          const diff = reportDate.getDate() - day + (day === 0 ? -6 : 1);
          startDate = new Date(reportDate);
          startDate.setDate(diff);
          endDate = new Date(startDate);
          endDate.setDate(startDate.getDate() + 6);
          
          reportTitle = `Reporte_Semanal_${startDate.toISOString().split('T')[0]}_${endDate.toISOString().split('T')[0]}`;
        } else {
          startDate = new Date(reportDate.getFullYear(), reportDate.getMonth(), 1);
          endDate = new Date(reportDate.getFullYear(), reportDate.getMonth() + 1, 0);
          
          reportTitle = `Reporte_Mensual_${monthsInSpanish[startDate.getMonth()]}_${startDate.getFullYear()}`;
        }
        
        // Create CSV content
        let csvContent = 'data:text/csv;charset=utf-8,';
        csvContent += 'Fecha,Ventas,Gastos Totales,Gastos Panadería,Ganancia Bruta,Ganancia Neta\n';
        
        // Loop through each day in the range
        for (let d = new Date(startDate.getTime()); d <= endDate; d.setDate(d.getDate() + 1)) {
          const date = new Date(d);
          const dateStr = getLocalDateKey(date);
          const readableDate = `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`;
          const dateExpensesKey = `expenses_${dateStr}`;
          const dateSalesKey = `sales_${dateStr}`;
          
          // Get data
          const dateSales = parseFloat(localStorage.getItem(dateSalesKey)) || 0;
          const dateExpenses = JSON.parse(localStorage.getItem(dateExpensesKey)) || [];
          const dateExpensesTotal = dateExpenses.reduce((total, expense) => total + expense.price, 0);
          const dateBakeryExpensesTotal = dateExpenses
            .filter(expense => expense.belongsToBakery)
            .reduce((total, expense) => total + expense.price, 0);
            
          const dateGrossProfit = dateSales - dateExpensesTotal;
          const dateNetProfit = dateSales - dateBakeryExpensesTotal;
          
          // Add to CSV
          csvContent += `${readableDate},${dateSales.toFixed(2)},${dateExpensesTotal.toFixed(2)},${dateBakeryExpensesTotal.toFixed(2)},${dateGrossProfit.toFixed(2)},${dateNetProfit.toFixed(2)}\n`;
        }
        
        // Add totals row
        const totalSales = parseFloat(document.getElementById('report-total-sales').textContent.replace('$', ''));
        const totalExpenses = parseFloat(document.getElementById('report-total-expenses').textContent.replace('$', ''));
        const totalBakeryExpenses = parseFloat(document.getElementById('report-total-bakery-expenses').textContent.replace('$', ''));
        const grossProfit = parseFloat(document.getElementById('report-gross-profit').textContent.replace('$', ''));
        const netProfit = parseFloat(document.getElementById('report-net-profit').textContent.replace('$', ''));
        
        csvContent += `TOTALES,${totalSales.toFixed(2)},${totalExpenses.toFixed(2)},${totalBakeryExpenses.toFixed(2)},${grossProfit.toFixed(2)},${netProfit.toFixed(2)}\n`;
        
        // Create download link
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement('a');
        link.setAttribute('href', encodedUri);
        link.setAttribute('download', `${reportTitle}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      });
    });
  </script>
</body>
</html>